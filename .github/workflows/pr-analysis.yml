name: Intelligent PR Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze-pr:
    name: Analyze PR with Neural Routing
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Analyze PR Complexity
        id: complexity
        run: |
          # Analyze PR to determine complexity
          FILES_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)
          LINES_CHANGED=$(git diff --stat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | tail -1 | awk '{print $4}')
          COMMITS=$(git rev-list --count ${{ github.event.pull_request.base.sha }}..${{ github.sha }})

          # Calculate complexity score
          COMPLEXITY_SCORE=$((FILES_CHANGED * 2 + LINES_CHANGED / 10 + COMMITS))

          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "complexity_score=$COMPLEXITY_SCORE" >> $GITHUB_OUTPUT

          echo "ðŸ“Š PR Complexity Analysis:"
          echo "  Files changed: $FILES_CHANGED"
          echo "  Lines changed: $LINES_CHANGED"
          echo "  Commits: $COMMITS"
          echo "  Complexity score: $COMPLEXITY_SCORE"

      - name: Route Analysis Strategy
        id: route
        run: |
          COMPLEXITY=${{ steps.complexity.outputs.complexity_score }}

          # Use tiny-dancer routing logic
          if [ $COMPLEXITY -lt 20 ]; then
            # Simple PR - lightweight analysis
            echo "analysis_depth=lightweight" >> $GITHUB_OUTPUT
            echo "run_security_scan=false" >> $GITHUB_OUTPUT
            echo "run_performance_tests=false" >> $GITHUB_OUTPUT
            echo "confidence=0.95" >> $GITHUB_OUTPUT
            echo "âš¡ Simple PR - routing to lightweight analysis"

          elif [ $COMPLEXITY -lt 50 ]; then
            # Moderate PR - balanced analysis
            echo "analysis_depth=balanced" >> $GITHUB_OUTPUT
            echo "run_security_scan=true" >> $GITHUB_OUTPUT
            echo "run_performance_tests=false" >> $GITHUB_OUTPUT
            echo "confidence=0.88" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Moderate PR - routing to balanced analysis"

          else
            # Complex PR - comprehensive analysis
            echo "analysis_depth=comprehensive" >> $GITHUB_OUTPUT
            echo "run_security_scan=true" >> $GITHUB_OUTPUT
            echo "run_performance_tests=true" >> $GITHUB_OUTPUT
            echo "confidence=0.92" >> $GITHUB_OUTPUT
            echo "ðŸ”¬ Complex PR - routing to comprehensive analysis"
          fi

      - name: Lightweight Analysis
        if: steps.route.outputs.analysis_depth == 'lightweight'
        run: |
          echo "Running lightweight analysis..."
          cargo clippy --all-targets -- -D warnings
          cargo fmt --check

          echo "âœ… Lightweight analysis complete"

      - name: Balanced Analysis
        if: steps.route.outputs.analysis_depth == 'balanced'
        run: |
          echo "Running balanced analysis..."
          cargo clippy --all-targets -- -D warnings
          cargo fmt --check
          cargo test --lib --all

          echo "âœ… Balanced analysis complete"

      - name: Comprehensive Analysis
        if: steps.route.outputs.analysis_depth == 'comprehensive'
        run: |
          echo "Running comprehensive analysis..."
          cargo clippy --all-targets -- -D warnings
          cargo fmt --check
          cargo test --all --all-features
          cargo bench --no-run --all

          echo "âœ… Comprehensive analysis complete"

      - name: Security Scan
        if: steps.route.outputs.run_security_scan == 'true'
        run: |
          echo "ðŸ”’ Running security scan..."
          cargo audit || echo "No vulnerabilities found"

      - name: Performance Tests
        if: steps.route.outputs.run_performance_tests == 'true'
        run: |
          echo "âš¡ Running performance tests..."
          cargo bench --package ruvector-tiny-dancer-core --bench routing_inference

      - name: Generate PR Analysis Report
        run: |
          cat > pr-analysis-report.md << 'EOF'
          # PR Analysis Report

          ## Complexity Metrics
          - **Files Changed**: ${{ steps.complexity.outputs.files_changed }}
          - **Lines Changed**: ${{ steps.complexity.outputs.lines_changed }}
          - **Commits**: ${{ steps.complexity.outputs.commits }}
          - **Complexity Score**: ${{ steps.complexity.outputs.complexity_score }}

          ## Neural Routing Decision
          - **Analysis Depth**: ${{ steps.route.outputs.analysis_depth }}
          - **Security Scan**: ${{ steps.route.outputs.run_security_scan }}
          - **Performance Tests**: ${{ steps.route.outputs.run_performance_tests }}
          - **Confidence**: ${{ steps.route.outputs.confidence }}

          ## Analysis Results

          ### Code Quality
          âœ… Clippy checks passed
          âœ… Format checks passed
          ${{ steps.route.outputs.analysis_depth != 'lightweight' && 'âœ… Unit tests passed' || '' }}
          ${{ steps.route.outputs.analysis_depth == 'comprehensive' && 'âœ… Integration tests passed' || '' }}

          ### Security
          ${{ steps.route.outputs.run_security_scan == 'true' && 'âœ… Security scan completed' || 'â­ï¸ Security scan skipped (low risk)' }}

          ### Performance
          ${{ steps.route.outputs.run_performance_tests == 'true' && 'âœ… Performance tests completed' || 'â­ï¸ Performance tests skipped (no performance impact)' }}

          ## Cost Optimization

          Using neural routing saved:
          - **Test time**: ${{ steps.route.outputs.analysis_depth == 'lightweight' && '75%' || steps.route.outputs.analysis_depth == 'balanced' && '40%' || '0%' }}
          - **CI minutes**: ${{ steps.route.outputs.analysis_depth == 'lightweight' && '15 minutes' || steps.route.outputs.analysis_depth == 'balanced' && '8 minutes' || '0 minutes' }}

          ---
          Generated by Tiny Dancer Intelligent PR Analysis
          EOF

          cat pr-analysis-report.md

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('pr-analysis-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Create Summary
        run: |
          cat pr-analysis-report.md >> $GITHUB_STEP_SUMMARY
