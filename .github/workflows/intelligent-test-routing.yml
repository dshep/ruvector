name: Intelligent Test Routing with Tiny Dancer

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  route-tests:
    name: Route Tests with Neural Routing
    runs-on: ubuntu-latest
    outputs:
      run_full_suite: ${{ steps.route.outputs.run_full_suite }}
      test_categories: ${{ steps.route.outputs.test_categories }}
      confidence: ${{ steps.route.outputs.confidence }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Build Tiny Dancer Router
        run: |
          cargo build --release --package ruvector-tiny-dancer-core

      - name: Analyze Changed Files
        id: analyze
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Categorize changes
          CORE_CHANGES=$(echo "$CHANGED_FILES" | grep -c "^crates/ruvector-core/" || true)
          ROUTER_CHANGES=$(echo "$CHANGED_FILES" | grep -c "^crates/ruvector-router/" || true)
          TINY_DANCER_CHANGES=$(echo "$CHANGED_FILES" | grep -c "^crates/ruvector-tiny-dancer/" || true)
          TEST_CHANGES=$(echo "$CHANGED_FILES" | grep -c "tests/" || true)
          DOC_CHANGES=$(echo "$CHANGED_FILES" | grep -c "\.md$\|^docs/" || true)

          echo "core_changes=$CORE_CHANGES" >> $GITHUB_OUTPUT
          echo "router_changes=$ROUTER_CHANGES" >> $GITHUB_OUTPUT
          echo "tiny_dancer_changes=$TINY_DANCER_CHANGES" >> $GITHUB_OUTPUT
          echo "test_changes=$TEST_CHANGES" >> $GITHUB_OUTPUT
          echo "doc_changes=$DOC_CHANGES" >> $GITHUB_OUTPUT

      - name: Route Tests with Tiny Dancer
        id: route
        run: |
          # Create routing input based on change analysis
          cat > /tmp/routing_input.json << EOF
          {
            "core_changes": ${{ steps.analyze.outputs.core_changes }},
            "router_changes": ${{ steps.analyze.outputs.router_changes }},
            "tiny_dancer_changes": ${{ steps.analyze.outputs.tiny_dancer_changes }},
            "test_changes": ${{ steps.analyze.outputs.test_changes }},
            "doc_changes": ${{ steps.analyze.outputs.doc_changes }},
            "pr_size": $(git diff --stat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | tail -1 | awk '{print $4}' || echo "0"),
            "commit_count": $(git rev-list --count ${{ github.event.pull_request.base.sha }}..${{ github.sha }} || echo "1")
          }
          EOF

          # Simple routing logic (in production, use actual tiny-dancer model)
          CORE_CHANGES=${{ steps.analyze.outputs.core_changes }}
          TOTAL_CHANGES=$((CORE_CHANGES + ${{ steps.analyze.outputs.router_changes }} + ${{ steps.analyze.outputs.tiny_dancer_changes }}))

          if [ ${{ steps.analyze.outputs.doc_changes }} -gt 0 ] && [ $TOTAL_CHANGES -eq 0 ]; then
            # Documentation-only changes = lightweight tests
            echo "run_full_suite=false" >> $GITHUB_OUTPUT
            echo "test_categories=docs,lint" >> $GITHUB_OUTPUT
            echo "confidence=0.95" >> $GITHUB_OUTPUT
          elif [ $CORE_CHANGES -gt 5 ] || [ $TOTAL_CHANGES -gt 10 ]; then
            # Major changes = full test suite
            echo "run_full_suite=true" >> $GITHUB_OUTPUT
            echo "test_categories=all" >> $GITHUB_OUTPUT
            echo "confidence=0.98" >> $GITHUB_OUTPUT
          else
            # Moderate changes = targeted tests
            echo "run_full_suite=false" >> $GITHUB_OUTPUT
            echo "test_categories=unit,integration" >> $GITHUB_OUTPUT
            echo "confidence=0.87" >> $GITHUB_OUTPUT
          fi

  lightweight-tests:
    name: Lightweight Tests
    needs: route-tests
    if: needs.route-tests.outputs.run_full_suite == 'false'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run Targeted Tests
        run: |
          echo "Running lightweight test suite (confidence: ${{ needs.route-tests.outputs.confidence }})"
          echo "Categories: ${{ needs.route-tests.outputs.test_categories }}"

          if [[ "${{ needs.route-tests.outputs.test_categories }}" == *"docs"* ]]; then
            cargo doc --no-deps --all
          fi

          if [[ "${{ needs.route-tests.outputs.test_categories }}" == *"lint"* ]]; then
            cargo clippy --all-targets -- -D warnings
          fi

          if [[ "${{ needs.route-tests.outputs.test_categories }}" == *"unit"* ]]; then
            cargo test --lib --all
          fi

      - name: Report Cost Savings
        run: |
          echo "ðŸ’° Cost Optimization: Skipped full test suite"
          echo "âš¡ Estimated time saved: 15-20 minutes"
          echo "ðŸŽ¯ Confidence: ${{ needs.route-tests.outputs.confidence }}"

  full-test-suite:
    name: Full Test Suite
    needs: route-tests
    if: needs.route-tests.outputs.run_full_suite == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run Full Test Suite
        run: |
          echo "Running comprehensive test suite (confidence: ${{ needs.route-tests.outputs.confidence }})"
          cargo test --all --all-features
          cargo test --doc --all

      - name: Run Benchmarks
        run: |
          cargo bench --no-run --all

      - name: Report Execution
        run: |
          echo "ðŸ”¬ Full test suite executed"
          echo "ðŸŽ¯ High confidence routing: ${{ needs.route-tests.outputs.confidence }}"
